<div class="editor-view">
  
  <div class="editor-head">
    <h2 *ngIf="!isUpdate">Thing Description Editor: {{ nombreTD }}</h2>
    <h2 *ngIf="isUpdate">Updating Thing Description: {{ nombreTD }}</h2>

    <button type="button" class="btn-ghost" (click)="toggleAll()">
      {{ areAllOpen ? '▾ Collapse all' : '▸ Expand all' }}
    </button>
  </div>

  <details (toggle)="onToggleGeneral($event)" [open]="generalAbierto">
    <summary>
      <div class="summary-left">
        <span class="arrow">▸</span>
        <span>General Information</span>
      </div>
    </summary>
    <app-general [datos]="tdService.obtenerTD()" 
                 [(nombre)]="nombreTD">
    </app-general>
  </details>
  
  <details (toggle)="onTogglePropiedades($event)" [open]="propiedadesAbierto">
    <summary>
      <div class="summary-left">
        <span class="arrow">▸</span>
        <span>Properties</span>
      </div>
      <ng-container *ngIf="propiedadesAbierto">
        <button class="icon-btn" *ngIf="!mostrarPropiedad" (click)="mostrarPropiedad = true">
          <img src="assets/add.png" alt="Añadir propiedad">
        </button>

        <ng-container *ngIf="mostrarPropiedad">
          <ng-container *ngTemplateOutlet="botonesComunes; context: { seccion: 'propiedad' }"></ng-container>
        </ng-container>
      </ng-container>     
    </summary>

    <div *ngIf="!mostrarPropiedad && propiedadesLista.length == 0" class="vacio">
      <p>No properties added.</p>
    </div>

    <div *ngIf="!mostrarPropiedad && propiedadesLista.length > 0">
      <ul>
        <li *ngFor="let prop of propiedadesLista">
          <div (click)="editarPropiedad(prop)">{{ prop }}</div>
          <button (click)="eliminarPropiedad(prop)" class="delete-btn">
            <img src="assets/cancelar.png" alt="Eliminar propiedad" />
          </button>
        </li>
      </ul>
    </div>

    <ng-container *ngIf="mostrarPropiedad">
      <app-propiedad [datos]="propiedadActual" (datosChange)="propiedadActual = $event"></app-propiedad>
      
      <div class="bottom-actions-container">
        <ng-container *ngTemplateOutlet="botonesComunes; context: { seccion: 'propiedad' }"></ng-container>
      </div>
    </ng-container>
  </details>
  
  <details (toggle)="onToggleAcciones($event)" [open]="accionesAbierto">
    <summary>
      <div class="summary-left">
        <span class="arrow">▸</span>
        <span>Actions</span>
      </div>
      <ng-container *ngIf="accionesAbierto">
        <button class="icon-btn" *ngIf="!mostrarAccion && accionesAbierto" (click)="mostrarAccion = true">
          <img src="assets/add.png" alt="Añadir accion">
        </button>          
        
        <ng-container *ngIf="mostrarAccion">
          <ng-container *ngTemplateOutlet="botonesComunes; context: { seccion: 'accion' }"></ng-container>
        </ng-container>
      </ng-container>    
    </summary>
  
    <div *ngIf="!mostrarAccion && accionesLista.length == 0" class="vacio">
      <p>No actions added.</p>
    </div>

    <div *ngIf="!mostrarAccion && accionesLista.length > 0">
      <ul>
        <li *ngFor="let prop of accionesLista">
          <div (click)="editarAccion(prop)">{{ prop }}</div>
          <button (click)="eliminarAccion(prop)" class="delete-btn">
            <img src="assets/cancelar.png" alt="Eliminar accion" />
          </button>
        </li>
      </ul>
    </div>
  
    <ng-container *ngIf="mostrarAccion">
        <app-accion [datos]="accionActual" (datosChange)="accionActual = $event"></app-accion>
        <div class="bottom-actions-container">
          <ng-container *ngTemplateOutlet="botonesComunes; context: { seccion: 'accion' }"></ng-container>
        </div>
    </ng-container>
  </details>
  
  <details (toggle)="onToggleEventos($event)" [open]="eventosAbierto">
    <summary>
      <div class="summary-left">
        <span class="arrow">▸</span>
        <span>Events</span>
      </div>
      <ng-container *ngIf="eventosAbierto">
        <button class="icon-btn" *ngIf="!mostrarEvento && eventosAbierto" (click)="mostrarEvento = true">
          <img src="assets/add.png" alt="Añadir evento">
        </button>          
        
        <ng-container *ngIf="mostrarEvento">
          <ng-container *ngTemplateOutlet="botonesComunes; context: { seccion: 'evento' }"></ng-container>
        </ng-container>
      </ng-container>    
    </summary>

    <div *ngIf="!mostrarEvento && eventosLista.length == 0" class="vacio">
      <p>No events added.</p>
    </div>

    <div *ngIf="!mostrarEvento && eventosLista.length > 0">
      <ul>
        <li *ngFor="let prop of eventosLista">
          <div (click)="editarEvento(prop)">{{ prop }}</div>
          <button (click)="eliminarEvento(prop)" class="delete-btn">
            <img src="assets/cancelar.png" alt="Eliminar evento" />
          </button>
        </li>
      </ul>
    </div>

    <ng-container *ngIf="mostrarEvento">
        <app-evento [datos]="eventoActual" (datosChange)="eventoActual = $event"></app-evento>
        <div class="bottom-actions-container">
          <ng-container *ngTemplateOutlet="botonesComunes; context: { seccion: 'evento' }"></ng-container>
        </div>
    </ng-container>
  </details>
  
  <details (toggle)="onToggleLinks($event)" [open]="linksAbierto">
    <summary>
      <div class="summary-left">
        <span class="arrow">▸</span>
        <span>Links</span>
      </div>
      <ng-container *ngIf="linksAbierto">
        <button class="icon-btn" *ngIf="!mostrarLink && linksAbierto" (click)="mostrarLink = true">
          <img src="assets/add.png" alt="Añadir link">
        </button>          
      
        <ng-container *ngIf="mostrarLink">
          <ng-container *ngTemplateOutlet="botonesComunes; context: { seccion: 'link' }"></ng-container>
        </ng-container>
      </ng-container>    
    </summary>

    <div *ngIf="!mostrarLink && linksLista.length == 0" class="vacio">
      <p>No Links added.</p>
    </div>

    <div *ngIf="!mostrarLink && linksLista.length > 0">
      <ul>
        <li *ngFor="let link of linksLista">
          <div (click)="editarLink(link.href)">{{ link.href }}</div>
          <button (click)="eliminarLink(link.href)" class="delete-btn">
            <img src="assets/cancelar.png" alt="Eliminar link" />
          </button>
        </li>
      </ul>
    </div>

    <ng-container *ngIf="mostrarLink">
      <app-links [datos]="linkActual" (datosChange)="linkActual = $event"></app-links>
      <div class="bottom-actions-container">
        <ng-container *ngTemplateOutlet="botonesComunes; context: { seccion: 'link' }"></ng-container>
      </div>
    </ng-container>
  </details>

  <div class="buttons">
    <button *ngIf="isUpdate" class="btn-secondary" (click)="createNew()">
      Create New
    </button>

    <ng-container *ngIf="(user$ | async)">
        <button class="btn-user" (click)="guardarTD()">
            {{ isUpdate ? 'Update TD' : 'Save TD' }}
        </button>
    </ng-container>
    
    <button class="btn-file" (click)="abrirArchivo()">Open TD</button>
    
    <input type="file" accept=".json" #inputArchivo (change)="cargarArchivoTD($event)" style="display: none;" />

    <button class="btn-file" (click)="descargarTD()">Download TD</button>

    <button class="btn-danger" (click)="resetTD()">Clear TD</button>
  </div>

</div>

<ng-template #botonesComunes let-seccion="seccion">
  <div class="form-buttons">
    <button (click)="gestionarBotones(seccion, 'guardar')" title="Guardar">
      <img src="assets/tick.png" alt="Guardar">
    </button>
    <button (click)="gestionarBotones(seccion, 'cancelar')" title="Cancelar">
      <img src="assets/cancelar.png" alt="Cancelar">
    </button>
  </div>
</ng-template>